<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Documents</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .document-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: #e7f3ff;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .document-actions {
            margin-top: 10px;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Document Test Page</h1>
        <p>This page will help you test and view your uploaded documents.</p>
        
        <button class="button" onclick="loadDocuments()">Load My Documents</button>
        <button class="button" onclick="fixDocuments()">Fix Document Status</button>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="documents" class="documents-list"></div>
    </div>

    <script>
        const applicantId = '71920ab3-2079-4f57-8ea1-d8017dfb61c3';

        async function loadDocuments() {
            const statusDiv = document.getElementById('status');
            const documentsDiv = document.getElementById('documents');
            
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'Loading documents...';
            
            try {
                const response = await fetch(`/api/applicants/documents?applicant_id=${applicantId}`);
                const data = await response.json();
                
                if (data.success && data.documents) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `‚úÖ Found ${data.documents.length} document(s)`;
                    
                    documentsDiv.innerHTML = '';
                    data.documents.forEach(doc => {
                        const docDiv = document.createElement('div');
                        docDiv.className = 'document-item';
                        docDiv.innerHTML = `
                            <h3>üìÑ ${doc.file_name}</h3>
                            <p><strong>Type:</strong> ${doc.document_type}</p>
                            <p><strong>Size:</strong> ${doc.file_size ? (doc.file_size / 1024).toFixed(1) + ' KB' : 'Unknown'}</p>
                            <p><strong>Uploaded:</strong> ${new Date(doc.uploaded_date).toLocaleString()}</p>
                            <p><strong>Status:</strong> <span style="color: ${doc.status === 'verified' ? 'green' : doc.status === 'pending' ? 'orange' : 'red'}">${doc.status.toUpperCase()}</span></p>
                            <div class="document-actions">
                                <button class="btn btn-primary" onclick="viewDocument('${doc.id}')">üëÅÔ∏è View</button>
                                <button class="btn btn-success" onclick="downloadDocument('${doc.id}')">‚¨áÔ∏è Download</button>
                                <button class="btn btn-warning" onclick="verifyDocument('${doc.id}')">‚úÖ Verify</button>
                                <button class="btn btn-danger" onclick="deleteDocument('${doc.id}', '${doc.file_name}')">üóëÔ∏è Delete</button>
                            </div>
                        `;
                        documentsDiv.appendChild(docDiv);
                    });
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `‚ùå No documents found or error: ${data.error || 'Unknown error'}`;
                    documentsDiv.innerHTML = '';
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
                documentsDiv.innerHTML = '';
            }
        }

        async function fixDocuments() {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'Fixing document status...';
            
            try {
                const response = await fetch('/api/fix-resume', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `‚úÖ ${data.message}`;
                    // Reload documents after fixing
                    setTimeout(loadDocuments, 1000);
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `‚ùå Error: ${data.error}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function viewDocument(documentId) {
            alert(`Viewing document: ${documentId}\n\nIn the real system, this would open a document viewer modal.`);
        }

        async function downloadDocument(documentId) {
            try {
                const response = await fetch(`/api/documents/download?document_id=${documentId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `document-${documentId}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to download document');
                }
            } catch (error) {
                alert('Error downloading document: ' + error.message);
            }
        }

        async function verifyDocument(documentId) {
            try {
                const response = await fetch('/api/documents/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        documentId: documentId,
                        action: 'verified',
                        verifiedBy: applicantId,
                        notes: 'Manually verified via test page'
                    })
                });
                
                if (response.ok) {
                    alert('Document verified successfully!');
                    loadDocuments(); // Reload documents
                } else {
                    alert('Failed to verify document');
                }
            } catch (error) {
                alert('Error verifying document: ' + error.message);
            }
        }

        async function deleteDocument(documentId, fileName) {
            if (confirm(`Are you sure you want to delete "${fileName}"?`)) {
                try {
                    const response = await fetch('/api/documents/delete', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ documentId: documentId })
                    });
                    
                    if (response.ok) {
                        alert('Document deleted successfully!');
                        loadDocuments(); // Reload documents
                    } else {
                        alert('Failed to delete document');
                    }
                } catch (error) {
                    alert('Error deleting document: ' + error.message);
                }
            }
        }

        // Auto-load documents when page loads
        window.onload = function() {
            loadDocuments();
        };
    </script>
</body>
</html>
